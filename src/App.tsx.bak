import { BrowserRouter, Routes, Route } from "react-router-dom";
import LifecycleBreakdown from "./pages/LifecycleBreakdown";
// src/App.tsx
import { useEffect, useMemo, useState } from "react";
import type { Material } from "./types";
import { loadMaterials } from "./lib/loadMaterials";

function largestPhaseLabel(p: {
  pointOfOrigin: number; production: number; transport: number; construction: number; disposal: number;
}) {
  const entries: [string, number][] = [
    ["Origin", p.pointOfOrigin],
    ["Production", p.production],
    ["Transport", p.transport],
    ["Construction", p.construction],
    ["Disposal", p.disposal],
  ];
  return entries.sort((a, b) => b[1] - a[1])[0][0];
}

export default function App() {
  const [all, setAll] = useState<Material[]>([]);
  const [query, setQuery] = useState("");
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        const rows = await loadMaterials();
        if (!cancelled) {
          setAll(rows);
          setError(null);
        }
      } catch (e: any) {
        if (!cancelled) {
          console.error(e);
          setError(e?.message || "Failed to load materials.");
        }
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return (
    <BrowserRouter>
      <Routes>
        <Route path="/lifecycle" element={<LifecycleBreakdown />} />
      </Routes>) => { cancelled = true; };
  }, []);

  const filtered = useMemo(() => {
    if (!query.trim()) return all;
    const q = query.toLowerCase();
    return all.filter(
      (m) =>
        m.name.toLowerCase().includes(q) ||
        m.materialType.toLowerCase().includes(q) ||
        (m.sourceRegion ?? "").toLowerCase().includes(q)
    );
  }, [all, query]);

  return (
    <BrowserRouter>
      <Routes>
        <Route path="/lifecycle" element={<LifecycleBreakdown />} />
      </Routes>
    <div className="min-h-screen bg-white text-slate-800">
      <main className="mx-auto max-w-6xl px-4 py-10">
        {/* Header */}
        <header className="mb-6">
          <h1 className="text-4xl font-bold tracking-tight">
            BlockPlane — Materials Explorer
          </h1>
          <p className="mt-2 text-sm text-slate-600">
            LIS/RIS/CPI-ready dataset (starter demo)
          </p>
        </header>

        {/* Controls */}
        <section className="mb-6 flex items-center gap-3">
          <input
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            placeholder="Search materials…"
            className="w-72 rounded-xl border border-slate-300 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400"
            aria-label="Search materials"
          />
          <a
            href="/lifecycle"
            className="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-700"
          >
            Lifecycle Breakdown →
          </a>
        </section>

        {/* States */}
        {loading && <div className="text-slate-600">Loading materials…</div>}

        {!loading && error && (
          <div className="rounded-xl border border-rose-200 bg-rose-50 p-4 text-rose-700">
            Error: {error}
          </div>
        )}

        {!loading && !error && (
          <>
            <table className="mt-4 w-full border-separate border-spacing-y-1">
              <thead>
                <tr className="text-left text-sm text-slate-600">
                  <th className="py-2 pr-4">Name</th>
                  <th className="py-2 pr-4">Category</th>
                  <th className="py-2 pr-4">Total (kg CO₂e)</th>
                  <th className="py-2 pr-4">Unit</th>
                  <th className="py-2 pr-4">Notes</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((m) => (
                  <tr key={m.id} className="border-b">
                    <td className="py-2 pr-4">{m.name}</td>
                    <td className="py-2 pr-4 text-slate-600">{m.materialType}</td>

                    {/* Replace EE / CO₂ columns with what you actually have */}
                    <td className="py-2 pr-4 text-slate-800 font-semibold">
                      {m.total.toLocaleString(undefined, { maximumFractionDigits: 1 })}
                    </td>
                    <td className="py-2 pr-4 text-slate-600">
                      {m.meta?.unit ?? "—"}
                    </td>

                    {/* Quick note: which phase is highest */}
                    <td className="py-2 pr-4 text-slate-600">
                      {largestPhaseLabel(m.phases)} is highest
                    </td>
                  </tr>
                ))}
                {filtered.length === 0 && (
                  <tr>
                    <td colSpan={5} className="py-6 text-center text-slate-600">
                      No materials match your search.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          
    </BrowserRouter>
  </>
        )}
      </main>
    </div>
  );
}
